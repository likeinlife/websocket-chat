# FastAPI + FastStream + RabbitMQ чат

Чат на вебсокетах и событийной системе

# Настройка и запуск

## Настройка

Перед работой приложения нужно настроить переменные окружения.

- Для локального запуска(приложение локально, rabbit в докере) - нужно скопировать `local.env` в `sciarticle_task/.env`
- Для запуска в докере - скопировать `docker.env` в `docker-compose/.env`

## Запуск

1. Запустить rabbit через докер. `make storages`
2. Запустить приложение
   1. Докер - `make app`
   2. Локально - `make app-local`
3. Закрыть приложение `make down-all`

# Эксплуатация и проверка работоспособности

Если следовать инструкции, то на локальном хосте должен открыться порт 8000.

Swagger находится на `http://127.0.0.1:8000/api/openapi`.

Подключение к вебсокету из консоли, используя утилиту `websocat`: `websocat ws://127.0.0.1:8000/ws/updates/<Номер комнаты:int>`

# Ремарка по поводу ТЗ

> Ремарка 1:  сообщения приходят только в комнату, где может состоять только 2 юзера

Не понял требования, поэтому не стал реализовывать функционал.
Необходимо разъяснить бизнес-требования:
1. Все комнаты должны содержать исключительно два человека?
2. Комнаты нужно создавать?
3. А нужно ли их удалять?
4. Если нужно удалять, то в какой момент? Если из комнаты вышли все люди, либо же вручную? Для обоих вариантов реализованы репозитории.
5. Не отправлять в каналы с одним человеком, чтобы не тратить ресурсы?

В зависимости от ответа будет разная реализация.
- 1 - Если комнаты содержат максимум два человека, то необходим дополнительный Query. В зависимости от количества участником сразу выдаст ошибку либо подключит.
- 2 - Дополнительный эндпоинт
- 3, 4 - Если удалять вручную, то новый эндпоинт. Если при условии, что комната пуста, то необходима дополнительная команда и запрос, которые будут срабатывать при выходе участников из комнаты.
- 5 - Если дело в экономии ресурсов, тогда т.к. сложной бизнес-логики здесь быть не может, тогда добавить дополнительные условия в infra/WebsocketConnectionManager

# Архитектура

Приложение построено на событийной системе, использующий паттерн "Посредник"(Mediator)

Ключевые составляющие Mediator:
1. Command, CommandHandler - команды и хендлеры для команд. Команды необходимы для каких-либо действий, меняющих состояние. Например, создание/удаление/редактирование объекта
2. Event, EventHandler - события и хендлеры для событий. События могут вызываться из любого места. Событием может быть результат выполнения команд, поступление новых данных от брокера и т.д.

Кроме того, приложение также выстроено по DDD:
1. Выделена доменная область - `domain`. В ней определены основные сущности, ошибки, события.
2. Выделен слой инфраструктуры - `infra`. В нем определена логика взаимодействия с внешними системами: вебсокеты, репозитории
3. Определен слой логики - `logic`. В нем содержится вся основная бизнес-логика. В проекте в нем содержатся медиаторы и сериализаторы
4. Выделен слой представления - `application`. В нем содержится, соответственно, вся логика работы с пользователем - через интерфейс FastAPI и FastStream
5. В корне проекта расположен `container.py` - DI контейнер.

## Плюсы и минусы архитектуры

Плюсы:
- Части проекта не связаны друг с другом. В любом момент, при необходимости, можно подменить какую-либо из зависимостей. Например, вместо In-Memory репозиториев сообщений и чатов, можно написать на PostgreSQL.
- При совместной разработке меньше шансов нарваться на конфликт.
- С одной командой можно связать несколько событий. Например, легко транслировать сообщение сразу в несколько источников.

Минусы:
- В уже написанный код тяжело вносить изменения: менять доменную модель и т.д..
- Тяжело разобраться в комплексной структуре. У меня заняло 48 часов, чтобы осознать, что происходит.

# Стек

1. Python3
2. FastAPI
3. FastStream
4. RabbitMQ
5. DependencyInjector
6. Docker, docker-compose
7. poetry
8. ruff, mypy, pre-commit
9. structlog

# Структура отправки сообщения

![post_message_pipeline](./diagrams/out/post_message.png)

# Скриншоты

![](./static/swagger.png)
![](./static/endpoint.png)
![](./static/response.png)
![](./static/message_id.png)
![](./static/websocket.png)
